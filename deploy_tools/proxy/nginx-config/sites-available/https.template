# Redirect the www subdomain
server {
	listen 443 ssl;
	server_name www.${SERVER_NAME};
	ssl_certificate ${SSL_CERT};
	ssl_certificate_key ${SSL_KEY};
	return 302 https://${SERVER_NAME}${DOLLAR}request_uri;
}

server {
	listen 443 ssl default_server;

	# Add expires headers
	expires 7d;

	client_max_body_size 4G;
	server_name _;

	ssl_certificate ${SSL_CERT};
	ssl_certificate_key ${SSL_KEY};

	keepalive_timeout 70;

	location / {
		proxy_set_header X-Forwarded-For ${DOLLAR}proxy_add_x_forwarded_for;
		proxy_set_header Host ${DOLLAR}host;
		proxy_redirect off;
		proxy_buffering off;

		proxy_pass http://site-server;
	}

    # Endpoint for websockify
    location ~* ^/vnc/([0-9a-zA-Z]+)/websockify$ {
        proxy_http_version 1.1;
        proxy_set_header Upgrade ${DOLLAR}http_upgrade;
        proxy_set_header Connection "Upgrade";

        resolver 127.0.0.1:53 ipv6=off;
        set ${DOLLAR}backend "http://penlite-env-${DOLLAR}1:6080/websockify";
        proxy_pass ${DOLLAR}backend;
    }

    location ~* ^/vnc/([0-9a-zA-Z]+)/(.*) {
        proxy_set_header X-Forwarded-For ${DOLLAR}proxy_add_x_forwarded_for;
        proxy_set_header Host ${DOLLAR}host;
        proxy_redirect off;
        proxy_buffering off;

        resolver 127.0.0.1:53 ipv6=off;
        set ${DOLLAR}backend "http://penlite-env-${DOLLAR}1:6080/${DOLLAR}2";
	    proxy_pass ${DOLLAR}backend;
	}
}
